trigger:
- master

pool:
  name: Self-Hosted-Laptop
  demands: maven

resources:
  repositories:
  - repository: yourGitHubRepo
    type: github
    endpoint: git-service-connection
    name: sudhvihaan/Azure-CICD-Examples


stages:
- stage: Stage_CI_Azure_ResourceProvisioning_via_Terraform
  jobs:
    - job: DeployAzureApp
      displayName: 'DM- Clone Git and navigate to Terraform Directory'
      steps:
      - script: |
          git clone https://github.com/sudhvihaan/Azure-CICD-Examples.git
          # Now, navigate to the specific subdirectory
          cd Azure-CICD-Examples/05-CICDPL-Java-SprintBootApp2-AzureWebApps/Terraform
          


      - task: TerraformTaskV4@4
        displayName: 'DM-Terraform Init'
        inputs:
          provider: 'azurerm'
          command: 'init'
          workingDirectory: '$(Build.SourcesDirectory)/05-CICDPL-Java-SprintBootApp2-AzureWebApps/Terraform'
          backendServiceArm: 'Service-Connection-To-Koushik-ProjectCICD-2nd'
          backendAzureRmResourceGroupName: 'AKS-HEMLDemo'
          backendAzureRmStorageAccountName: 'storageac6674'
          backendAzureRmContainerName: 'storestafefile'
          backendAzureRmKey: 'state-2nd-JSB.tfstate'

      - task: TerraformTaskV4@4
        displayName: 'DM-Terraform Validate'
        inputs:
          provider: 'azurerm'
          command: 'validate'
          workingDirectory: '$(Build.SourcesDirectory)/05-CICDPL-Java-SprintBootApp2-AzureWebApps/Terraform'

      - task: TerraformTaskV4@4
        displayName: 'DM-Terraform Plan'
        inputs:
          provider: 'azurerm'
          command: 'plan'
          environmentServiceNameAzureRM: 'Service-Connection-To-Koushik-ProjectCICD-2nd' 
          workingDirectory: '$(Build.SourcesDirectory)/05-CICDPL-Java-SprintBootApp2-AzureWebApps/Terraform'
        

      - task: TerraformTaskV4@4
        displayName: 'DM-Terraform Apply'
        inputs:
          provider: 'azurerm'
          command: 'apply'
          commandOptions: '--auto-approve'
          environmentServiceNameAzureRM: 'Service-Connection-To-Koushik-ProjectCICD-2nd'
          workingDirectory: '$(Build.SourcesDirectory)/05-CICDPL-Java-SprintBootApp2-AzureWebApps/Terraform'
